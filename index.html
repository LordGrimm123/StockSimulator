<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Simulator</title>
    <!-- Use Tailwind CSS for a professional, responsive look -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #03045E; /* Royal blue */
            color: #E8F1F2; /* Off-white */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .container {
            max-width: 900px;
            width: 100%;
            background-color: #0077B6; /* Darker royal blue */
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card {
            background-color: #0096C7; /* Brighter royal blue */
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .btn-primary {
            background-color: #00B4D8;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #90E0EF;
        }
        .btn-secondary {
            background-color: #0077B6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid #0077B6;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #00B4D8;
            border-color: #00B4D8;
        }

        .bar-graph-container {
            display: flex;
            flex-direction: row;
            align-items: flex-end;
            height: 150px;
            overflow-x: auto;
            border: 1px solid #E8F1F2;
            border-radius: 0.5rem;
            padding: 0.25rem;
            /* Added smooth scrolling for a continuous motion effect */
            scroll-behavior: smooth;
        }

        .bar {
            width: 1rem;
            margin: 0 1px;
            transition: height 0.3s ease-out, background-color 0.3s ease-out;
            min-width: 1rem;
        }
        
    </style>
</head>
<body class="bg-blue-900 text-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main application container -->
    <div id="app" class="container">
        
        <!-- Loading Screen -->
        <div id="loading-screen" class="p-6 text-center">
            <h1 class="text-2xl font-bold text-white mb-4">Loading...</h1>
            <p class="text-sm opacity-75">Establishing connection and fetching data.</p>
        </div>

        <!-- Login Form -->
        <div id="login-screen" class="p-6 hidden">
            <h1 class="text-3xl font-bold text-center mb-6 text-white">Stock Simulator Login</h1>
            <div class="card p-6">
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-white">Enter Email:</label>
                        <input type="email" id="email" name="email" placeholder="admin@example.com or trader1@example.com"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-gray-900">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-white">Enter Password:</label>
                        <input type="password" id="password" name="password" placeholder="adminpass or traderpass"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-gray-900">
                    </div>
                    <button type="submit" class="w-full btn-primary text-lg font-bold">Log In</button>
                </form>
                <!-- Added a hint for the user with the correct credentials -->
                <p class="text-sm text-center text-gray-300 mt-4">
                    <span class="font-bold">Hint:</span> Use 'trader1@example.com' with password 'traderpass' or 'admin@example.com' with password 'adminpass'.
                </p>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-screen" class="hidden">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-white mb-2 sm:mb-0">Admin Dashboard</h1>
                <div class="flex items-center space-x-4">
                    <p class="text-sm opacity-75">User ID: <span id="admin-user-id" class="font-bold"></span></p>
                    <button id="logout-btn-admin" class="btn-secondary">Log Out</button>
                </div>
            </div>
            
            <div id="admin-stock-list-container" class="card">
                <h2 class="text-xl font-semibold mb-4 text-white">Available Stocks</h2>
                <div id="admin-stock-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- Stock items will be populated here -->
                </div>
            </div>

            <div class="card">
                <h2 class="text-xl font-semibold mb-4 text-white">Control Panel</h2>
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                    <div class="w-full">
                        <label for="stock-control" class="block text-sm font-medium text-white">Select Stock to Control:</label>
                        <select id="stock-control" class="mt-1 block w-full rounded-md shadow-sm p-2 text-gray-900"></select>
                    </div>
                    <div class="flex items-center space-x-2 w-full sm:w-auto">
                        <button id="raise-btn" class="flex-1 btn-primary">Raise</button>
                        <button id="lower-btn" class="flex-1 btn-primary">Lower</button>
                    </div>
                </div>
            </div>

            <div class="card mt-6">
                <h2 class="text-xl font-semibold mb-4 text-white">Trader Management</h2>
                <div class="space-y-4">
                    <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
                        <label for="start-amount" class="block text-sm font-medium text-white">Starting Funds:</label>
                        <input type="number" id="start-amount" placeholder="e.g., 10000"
                               class="mt-1 block w-full rounded-md shadow-sm p-2 text-gray-900">
                        <button id="set-funds-btn" class="w-full sm:w-auto btn-primary">Set Funds</button>
                    </div>
                    <div>
                        <label for="trader-list" class="block text-sm font-medium text-white">Select Trader:</label>
                        <select id="trader-list" class="mt-1 block w-full rounded-md shadow-sm p-2 text-gray-900"></select>
                    </div>
                </div>
                <div id="trader-portfolio-view" class="mt-4 p-4 rounded-md bg-blue-800 text-sm">
                    <!-- Portfolio details will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Trader Dashboard -->
        <div id="trader-screen" class="hidden p-6">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-white mb-2 sm:mb-0">Trader Portfolio</h1>
                <div class="flex items-center space-x-4">
                    <p class="text-sm opacity-75">User ID: <span id="trader-user-id" class="font-bold"></span></p>
                    <button id="logout-btn-trader" class="btn-secondary hidden sm:block">Log Out</button>
                </div>
            </div>

            <!-- New section for key metrics -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 text-white">Your Financial Summary</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                    <div class="bg-blue-800 rounded-lg p-4">
                        <p class="text-sm opacity-75">Investment Capital</p>
                        <p class="font-bold text-xl mt-1">$<span id="investment-capital">0</span></p>
                    </div>
                    <div class="bg-blue-800 rounded-lg p-4">
                        <p class="text-sm opacity-75">Working Capital</p>
                        <p class="font-bold text-xl mt-1">$<span id="working-capital">0</span></p>
                    </div>
                    <div class="bg-blue-800 rounded-lg p-4">
                        <p class="font-bold text-xl mt-1"><span id="profit-loss">0</span></p>
                    </div>
                </div>
            </div>
            
            <div id="stock-list-container" class="card">
                <h2 class="text-xl font-semibold mb-4 text-white">Available Stocks</h2>
                <div id="stock-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- Stock buttons will be populated here -->
                </div>
            </div>

            <div id="stock-details" class="card mt-6 hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">
                    <span id="selected-stock-name"></span>
                </h2>
                <div class="bar-graph-container">
                    <div id="bar-graph" class="flex items-end h-full"></div>
                </div>
                
                <div class="mt-4 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 items-center">
                    <label for="quantity" class="text-white font-medium">Quantity:</label>
                    <input type="number" id="quantity" value="1" min="1"
                           class="w-full sm:w-auto p-2 rounded-md text-gray-900">
                    <button id="buy-btn" class="flex-1 btn-primary">Buy</button>
                    <button id="sell-btn" class="flex-1 btn-primary">Sell</button>
                    <div class="flex-1">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="auto-sell" class="form-checkbox h-5 w-5 text-red-600 rounded">
                            <span class="ml-2 text-white">Auto-Sell at Low</span>
                        </label>
                        <input type="number" id="auto-sell-price" placeholder="Price" min="1" step="0.01" class="mt-2 block w-full rounded-md shadow-sm p-2 text-gray-900 hidden">
                    </div>
                </div>
            </div>

            <!-- New section for the trader's portfolio -->
            <div id="trader-portfolio-container" class="card mt-6">
                <h2 class="text-xl font-semibold mb-4 text-white">Your Portfolio</h2>
                <div id="trader-portfolio-list" class="space-y-4">
                    <!-- Portfolio items will be populated here -->
                </div>
            </div>
        </div>

    </div>

    <!-- JavaScript for all functionality -->
    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, addDoc, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        // --- Firebase Initialization and Auth ---
        let db, auth;
        
        // GLOBAL VARIABLES PROVIDED BY THE CANVAS ENVIRONMENT
        const __app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const __firebase_config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const __initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (__firebase_config) {
            const app = initializeApp(__firebase_config);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');
        } else {
             console.error("Firebase config is missing.");
        }

        let currentUser = null;
        let selectedStock = null;
        let userId = null; // The authenticated Firebase user ID
        let priceFluctuationInterval;
        let autoSellInterval;

        // Data and State
        let stocks = [];
        let traders = {};
        let roles = {};

        // DOM elements
        const loadingScreen = document.getElementById("loading-screen");
        const loginScreen = document.getElementById("login-screen");
        const adminScreen = document.getElementById("admin-screen");
        const traderScreen = document.getElementById("trader-screen");
        const stockListContainer = document.getElementById("stock-list");
        const adminStockListContainer = document.getElementById("admin-stock-list");
        const stockDetailsContainer = document.getElementById("stock-details");
        const barGraphElement = document.getElementById("bar-graph");
        const investmentCapitalElement = document.getElementById('investment-capital');
        const workingCapitalElement = document.getElementById('working-capital');
        const profitLossElement = document.getElementById('profit-loss');
        const selectedStockNameElement = document.getElementById("selected-stock-name");
        const adminUserIdElement = document.getElementById('admin-user-id');
        const traderUserIdElement = document.getElementById('trader-user-id');
        const autoSellCheckbox = document.getElementById('auto-sell');
        const autoSellPriceInput = document.getElementById('auto-sell-price');
        const traderPortfolioList = document.getElementById('trader-portfolio-list');
        
        // --- Custom Alert/Prompt UI ---
        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = `fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50`;
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl text-gray-800 text-center max-w-sm mx-auto">
                    <p class="text-lg mb-4">${message}</p>
                    <button class="btn-primary" onclick="this.parentElement.parentElement.remove()">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // This function shows or hides different parts of the UI
        function showScreen(screenId) {
            loadingScreen.classList.add("hidden");
            loginScreen.classList.add("hidden");
            adminScreen.classList.add("hidden");
            traderScreen.classList.add("hidden");

            if (screenId === "login") {
                loginScreen.classList.remove("hidden");
            } else if (screenId === "admin") {
                adminScreen.classList.remove("hidden");
            } else if (screenId === "trader") {
                traderScreen.classList.remove("hidden");
            }
        }
        
        // Log out function
        async function logout() {
            if (auth) {
                await signOut(auth);
                currentUser = null;
                selectedStock = null;
                clearInterval(priceFluctuationInterval);
                clearInterval(autoSellInterval);
                showScreen('login');
            }
        }
        
        // Renders the live bar graph
        function renderGraph(stock) {
            if (!stock) return;
            selectedStockNameElement.textContent = `${stock.name} Live Chart ($${stock.price.toFixed(2)})`;
            barGraphElement.innerHTML = ''; // Clear previous bars
            const history = stock.history || [];
            if (history.length === 0) return;

            const maxVal = Math.max(...history) * 1.05;
            const minVal = Math.min(...history) * 0.95;

            history.forEach((price, index) => {
                const heightPercentage = ((price - minVal) / (maxVal - minVal)) * 100;
                const barColor = index > 0 && price >= history[index - 1] ? 'bg-green-500' : 'bg-red-500';
                const bar = document.createElement('div');
                bar.className = `bar ${barColor} relative`;
                bar.style.height = `${Math.max(10, heightPercentage)}%`; // Ensure a minimum height
                barGraphElement.appendChild(bar);
            });
            barGraphElement.scrollLeft = barGraphElement.scrollWidth;
        }

        // Refactored to centralize UI updates for all screens.
        function refreshUI() {
            // Update the trader's stock list
            stockListContainer.innerHTML = '';
            stocks.forEach(stock => {
                const stockButton = document.createElement('button');
                stockButton.className = 'w-full btn-secondary text-left p-4 rounded-lg flex justify-between items-center';
                stockButton.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-bold">${stock.name}</span>
                        <span id="stock-${stock.name.replace(/\s+/g, '-')}" class="text-sm opacity-75">$${stock.price.toFixed(2)}</span>
                    </div>
                `;
                stockButton.onclick = () => {
                    selectedStock = stock;
                    stockDetailsContainer.classList.remove('hidden');
                    renderGraph(selectedStock);
                };
                stockListContainer.appendChild(stockButton);
            });

            // Update the admin's stock list
            adminStockListContainer.innerHTML = '';
            stocks.forEach(stock => {
                const stockItem = document.createElement('div');
                stockItem.className = 'w-full text-left p-4 rounded-lg flex justify-between items-center bg-blue-800';
                stockItem.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-bold">${stock.name}</span>
                        <span id="admin-stock-${stock.name.replace(/\s+/g, '-')}" class="text-sm opacity-75">$${stock.price.toFixed(2)}</span>
                    </div>
                `;
                adminStockListContainer.appendChild(stockItem);
            });

            // Update the selected stock's graph if one is active
            if (selectedStock) {
                const updatedStock = stocks.find(s => s.name === selectedStock.name);
                if (updatedStock) {
                    selectedStock = updatedStock; // Update the reference to the latest data
                    renderGraph(selectedStock);
                }
            }
            
            // Update other UI components
            if (userId) {
                updateTraderStats(userId);
                renderTraderPortfolio(userId);
            }
            renderAdminDashboardControls();
        }

        function renderAdminDashboardControls() {
            // Populate the stock control dropdown
            const stockControl = document.getElementById("stock-control");
            stockControl.innerHTML = '';
            stocks.forEach(stock => {
                const option = document.createElement('option');
                option.value = stock.name;
                option.textContent = stock.name;
                stockControl.appendChild(option);
            });
            
            // Populate the trader list dropdown
            const traderList = document.getElementById("trader-list");
            traderList.innerHTML = '';
            // Only show traders, not the admin
            const traderUids = Object.keys(roles).filter(uid => roles[uid].role === 'trader');
            traderUids.forEach(uid => {
                const option = document.createElement('option');
                option.value = uid;
                option.textContent = roles[uid].email; // Display email for clarity
                traderList.appendChild(option);
            });
        }
        
        // Updates the cash and portfolio value display for the trader
        function updateTraderStats(traderUid) {
            if (!traderUid || !traders[traderUid]) return;
            const trader = traders[traderUid];
            
            // Calculate total portfolio value
            let portfolioValue = 0;
            const userPortfolio = trader.portfolio || {};
            for (const stockName in userPortfolio) {
                const ownedStock = userPortfolio[stockName];
                const stock = stocks.find(s => s.name === stockName);
                if (stock) {
                    portfolioValue += ownedStock.quantity * stock.price;
                }
            }
            
            // Get initial and current cash
            const initialCash = trader.initialCash || 0;
            const currentCash = trader.cash || 0;

            // Calculate metrics
            const investmentCapital = portfolioValue;
            const workingCapital = currentCash;
            const totalValue = investmentCapital + workingCapital;
            const profitOrLoss = totalValue - initialCash;
            const profitLossPercentage = initialCash === 0 ? 0 : (profitOrLoss / initialCash) * 100;

            // Update DOM elements
            investmentCapitalElement.textContent = investmentCapital.toFixed(2);
            workingCapitalElement.textContent = workingCapital.toFixed(2);

            // Update profit/loss display with color and percentage
            profitLossElement.textContent = `${profitOrLoss >= 0 ? '+' : ''}${profitOrLoss.toFixed(2)} (${profitLossPercentage.toFixed(2)}%)`;
            profitLossElement.classList.toggle('text-green-500', profitOrLoss >= 0);
            profitLossElement.classList.toggle('text-red-500', profitOrLoss < 0);
        }

        function renderTraderPortfolio(traderUid) {
            if (!traderUid || !traders[traderUid]) return;
            const trader = traders[traderUid];
            traderPortfolioList.innerHTML = '';

            const userPortfolio = trader.portfolio || {};
            for (const stockName in userPortfolio) {
                const ownedStock = userPortfolio[stockName];
                const stock = stocks.find(s => s.name === stockName);
                if (ownedStock.quantity > 0 && stock) {
                    const portfolioItem = document.createElement('div');
                    portfolioItem.className = 'flex flex-col sm:flex-row justify-between items-center p-4 bg-blue-800 rounded-lg';
                    
                    const autoSellText = ownedStock.autoSellPrice ? `Auto-sell at $${ownedStock.autoSellPrice.toFixed(2)}` : 'No auto-sell set';

                    portfolioItem.innerHTML = `
                        <div class="flex flex-col mb-2 sm:mb-0">
                            <span class="font-bold">${stockName}</span>
                            <span class="text-sm opacity-75">Quantity: ${ownedStock.quantity}</span>
                            <span class="text-sm opacity-75">Current Value: $${(ownedStock.quantity * stock.price).toFixed(2)}</span>
                        </div>
                        <div class="flex flex-col text-right">
                            <span class="text-sm opacity-75">${autoSellText}</span>
                        </div>
                    `;
                    traderPortfolioList.appendChild(portfolioItem);
                }
            }
        }

        // --- Firebase Firestore Listeners ---

        // Listen for real-time stock price updates
        function setupStockListener() {
            const stocksRef = collection(db, `/artifacts/${__app_id}/public/data/stocks`);
            onSnapshot(stocksRef, (snapshot) => {
                stocks = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                refreshUI(); // Call the unified UI refresh function
            });
        }
        
        // Listen for real-time trader updates
        function setupTradersListener() {
            const tradersRef = collection(db, `/artifacts/${__app_id}/public/data/traders`);
            onSnapshot(tradersRef, (snapshot) => {
                traders = {}; // Clear old data
                snapshot.docs.forEach(doc => {
                    traders[doc.id] = doc.data();
                });
                refreshUI();
            });
        }
        
        // Listen for real-time role updates
        function setupRolesListener() {
            const rolesRef = collection(db, `/artifacts/${__app_id}/public/data/roles`);
            onSnapshot(rolesRef, (snapshot) => {
                roles = {};
                snapshot.docs.forEach(doc => {
                    roles[doc.id] = doc.data();
                });
                refreshUI();
            });
        }
        
        // --- Event Listeners and Initial Setup ---
        
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!auth || !db) {
                showCustomAlert("Firebase is not initialized. Please check your config.");
                return;
            }

            try {
                // Use Firebase Authentication to sign in
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login error:", error);
                if (error.code === 'auth/invalid-credential') {
                    showCustomAlert("Invalid email or password.");
                } else {
                    showCustomAlert("An error occurred during login. Please try again.");
                }
            }
        });

        // Admin controls
        document.getElementById('raise-btn').addEventListener('click', async () => {
            const selectedStockName = document.getElementById('stock-control').value;
            const stock = stocks.find(s => s.name === selectedStockName);
            if (stock) {
                const newPrice = stock.price * 1.1;
                const newHistory = [...(stock.history || []), newPrice];
                if (newHistory.length > 20) newHistory.shift();

                const stockDocRef = doc(db, `/artifacts/${__app_id}/public/data/stocks`, stock.id);
                await setDoc(stockDocRef, { price: newPrice, history: newHistory }, { merge: true });
            }
        });

        document.getElementById('lower-btn').addEventListener('click', async () => {
            const selectedStockName = document.getElementById('stock-control').value;
            const stock = stocks.find(s => s.name === selectedStockName);
            if (stock) {
                const newPrice = Math.max(1, stock.price * 0.9);
                const newHistory = [...(stock.history || []), newPrice];
                if (newHistory.length > 20) newHistory.shift();

                const stockDocRef = doc(db, `/artifacts/${__app_id}/public/data/stocks`, stock.id);
                await setDoc(stockDocRef, { price: newPrice, history: newHistory }, { merge: true });
            }
        });

        document.getElementById('set-funds-btn').addEventListener('click', async () => {
            const traderUidToUpdate = document.getElementById('trader-list').value;
            const amount = parseFloat(document.getElementById('start-amount').value);
            if (traderUidToUpdate && !isNaN(amount) && amount >= 0) {
                const traderDocRef = doc(db, `/artifacts/${__app_id}/public/data/traders`, traderUidToUpdate);
                await setDoc(traderDocRef, { cash: amount, initialCash: amount }, { merge: true });
                showCustomAlert(`Set starting funds for ${roles[traderUidToUpdate].email} to $${amount.toFixed(2)}`);
            } else {
                showCustomAlert("Please enter a valid amount.");
            }
        });

        document.getElementById('trader-list').addEventListener('change', (e) => {
            const traderUid = e.target.value;
            const portfolioView = document.getElementById('trader-portfolio-view');
            const traderData = traders[traderUid];
            
            if (!traderData) return;

            let portfolioHtml = `<h3 class="font-bold text-white">Portfolio for ${roles[traderUid].email}</h3>`;
            portfolioHtml += `<p class="mt-2">Cash: $${traderData.cash ? traderData.cash.toFixed(2) : "0.00"}</p>`;
            
            let totalValue = traderData.cash || 0;
            for (const stockName in traderData.portfolio) {
                const ownedStock = traderData.portfolio[stockName];
                const quantity = ownedStock.quantity;
                const stock = stocks.find(s => s.name === stockName);
                if (quantity > 0 && stock) {
                    const value = quantity * stock.price;
                    totalValue += value;
                    portfolioHtml += `<p>${stockName}: ${quantity} shares ($${stock.price.toFixed(2)} each)</p>`;
                }
            }
            portfolioHtml += `<p class="font-bold text-white mt-2">Total Value: $${totalValue.toFixed(2)}</p>`;
            portfolioView.innerHTML = portfolioHtml;
        });

        // Trader controls
        document.getElementById('buy-btn').addEventListener('click', async () => {
            if (!selectedStock || !userId) return;
            const quantity = parseInt(document.getElementById('quantity').value, 10);
            const autoSellPrice = parseFloat(document.getElementById('auto-sell-price').value);

            if (isNaN(quantity) || quantity <= 0) {
                showCustomAlert("Please enter a valid quantity.");
                return;
            }
            
            const cost = quantity * selectedStock.price;
            const traderDocRef = doc(db, `/artifacts/${__app_id}/public/data/traders`, userId);
            const traderDocSnap = await getDoc(traderDocRef);
            const traderData = traderDocSnap.data();

            if (traderData.cash >= cost) {
                traderData.cash -= cost;
                traderData.portfolio = traderData.portfolio || {};
                
                traderData.portfolio[selectedStock.name] = {
                    quantity: (traderData.portfolio[selectedStock.name]?.quantity || 0) + quantity,
                    autoSellPrice: autoSellCheckbox.checked && !isNaN(autoSellPrice) ? autoSellPrice : null
                };

                await setDoc(traderDocRef, traderData);
                showCustomAlert(`Successfully bought ${quantity} shares of ${selectedStock.name}.`);
            } else {
                showCustomAlert("Not enough cash to buy.");
            }
        });

        document.getElementById('sell-btn').addEventListener('click', async () => {
            if (!selectedStock || !userId) return;
            const quantity = parseInt(document.getElementById('quantity').value, 10);
            if (isNaN(quantity) || quantity <= 0) {
                showCustomAlert("Please enter a valid quantity.");
                return;
            }

            const traderDocRef = doc(db, `/artifacts/${__app_id}/public/data/traders`, userId);
            const traderDocSnap = await getDoc(traderDocRef);
            const traderData = traderDocSnap.data();

            const ownedStock = traderData.portfolio?.[selectedStock.name];
            const ownedQuantity = ownedStock?.quantity || 0;
            if (ownedQuantity >= quantity) {
                traderData.cash += quantity * selectedStock.price;
                traderData.portfolio[selectedStock.name].quantity -= quantity;
                if (traderData.portfolio[selectedStock.name].quantity <= 0) {
                    delete traderData.portfolio[selectedStock.name];
                }
                await setDoc(traderDocRef, traderData);
                showCustomAlert(`Successfully sold ${quantity} shares of ${selectedStock.name}.`);
            } else {
                showCustomAlert("Not enough shares to sell.");
            }
        });
        
        // Toggle auto-sell price input visibility
        autoSellCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
                autoSellPriceInput.classList.remove('hidden');
            } else {
                autoSellPriceInput.classList.add('hidden');
            }
        });


        // Event listeners for the logout buttons
        document.getElementById('logout-btn-admin').addEventListener('click', logout);
        document.getElementById('logout-btn-trader').addEventListener('click', logout);
        
        // --- Firebase Initial Auth and Data Setup ---
        
        // Function to set up initial data in Firestore
        async function initializeFirestoreUsersAndStocks() {
            if (!db) return;
            
            // Define paths for public data collections
            const stocksRef = collection(db, `/artifacts/${__app_id}/public/data/stocks`);
            const tradersRef = collection(db, `/artifacts/${__app_id}/public/data/traders`);
            const rolesRef = collection(db, `/artifacts/${__app_id}/public/data/roles`);

            try {
                // Check if stocks exist
                const stocksSnap = await getDocs(stocksRef);
                if (stocksSnap.empty) {
                    console.log("Initializing Firestore with stock data...");
                    
                    // Array of unique-sounding stock names
                    const stockNames = [
                        'TechCorp', 'GlobalData', 'ApexInnovations', 'CyberDynamics', 'QuantumLeap',
                        'AetherSystems', 'NovaSolutions', 'FusionCore', 'TitanHoldings', 'PinnacleTech',
                        'Starlight', 'Moonstone', 'Solstice', 'Veridian', 'Aurelia',
                        'Zenith', 'Orion', 'Equinox', 'Radiant', 'Vanguard'
                    ];

                    for (let i = 0; i < 20; i++) {
                        const name = stockNames[i];
                        const initialPrice = parseFloat((Math.random() * 490 + 10).toFixed(2)); // Price between $10 and $500
                        const stock = { name: name, price: initialPrice, history: [initialPrice] };
                        await addDoc(stocksRef, stock);
                    }
                    console.log("Stocks initialized.");
                }
            } catch (error) {
                console.error("Error initializing Firestore data:", error);
            }
        }

        // Function to start automatic price fluctuations
        function startPriceFluctuation() {
            if (priceFluctuationInterval) {
                clearInterval(priceFluctuationInterval);
            }
            priceFluctuationInterval = setInterval(async () => {
                if (stocks.length === 0) return;
                
                const stocksToUpdate = stocks.map(s => ({...s}));
                
                for (let stock of stocksToUpdate) {
                    const change = (Math.random() - 0.5) * 0.05; // Random change between -2.5% and +2.5%
                    let newPrice = stock.price * (1 + change);
                    newPrice = Math.max(1, newPrice); // Ensure price doesn't go below $1
                    stock.price = parseFloat(newPrice.toFixed(2));
                    
                    // Update history
                    stock.history.push(stock.price);
                    if (stock.history.length > 20) {
                        stock.history.shift();
                    }

                    // Update Firestore
                    const stockDocRef = doc(db, `/artifacts/${__app_id}/public/data/stocks`, stock.id);
                    try {
                        await setDoc(stockDocRef, { price: stock.price, history: stock.history }, { merge: true });
                    } catch (error) {
                        console.error("Error updating stock price:", error);
                    }
                }
                
            }, 1000); // Update every 1 second
        }

        function startAutoSellCheck() {
            if (autoSellInterval) {
                clearInterval(autoSellInterval);
            }
            autoSellInterval = setInterval(async () => {
                if (!userId || !traders[userId] || stocks.length === 0) return;
                const traderData = traders[userId];
                const traderDocRef = doc(db, `/artifacts/${__app_id}/public/data/traders`, userId);
                let changesMade = false;

                const userPortfolio = traderData.portfolio || {};

                for (const stockName in userPortfolio) {
                    const ownedStock = userPortfolio[stockName];
                    const stock = stocks.find(s => s.name === stockName);
                    
                    if (ownedStock.autoSellPrice && stock && stock.price <= ownedStock.autoSellPrice) {
                        if (ownedStock.quantity > 0) {
                            traderData.cash += ownedStock.quantity * stock.price;
                            delete traderData.portfolio[stockName];
                            showCustomAlert(`Auto-sold all ${ownedStock.quantity} shares of ${stockName} at $${stock.price.toFixed(2)}.`);
                            changesMade = true;
                        }
                    }
                }

                if (changesMade) {
                    await setDoc(traderDocRef, traderData);
                }
            }, 5000); // Check every 5 seconds
        }

        // The central state management for the user
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid; // Set the global user ID
                
                // Get the user's role from Firestore
                const roleDocRef = doc(db, `/artifacts/${__app_id}/public/data/roles`, userId);
                const roleDocSnap = await getDoc(roleDocRef);
                const userRole = roleDocSnap.exists() ? roleDocSnap.data().role : null;
                
                if (userRole === 'admin') {
                     adminUserIdElement.textContent = userId;
                     showScreen('admin');
                } else if (userRole === 'trader') {
                    traderUserIdElement.textContent = userId;
                    showScreen('trader');
                    startAutoSellCheck();
                } else {
                    // This can happen if a user is authenticated but has no role document
                    showCustomAlert("User role not found. Please contact support.");
                    signOut(auth);
                    return;
                }
                
                // Start listeners for all public data
                setupStockListener();
                setupTradersListener();
                setupRolesListener(); // Listen for new users being created
                startPriceFluctuation();
            } else {
                userId = null;
                showScreen('login');
            }
        });
        
        async function initializeFirebase() {
            // Check for and use the provided auth token if it exists
            if (__initial_auth_token) {
                 try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                 } catch (error) {
                    console.error("Custom token sign-in failed:", error);
                 }
            }

            if (db) {
                initializeFirestoreUsersAndStocks();
            }
        }
        
        window.onload = initializeFirebase;

    </script>
</body>
</html>
